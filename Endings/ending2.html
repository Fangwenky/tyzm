<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>结局系统</title>
    <link rel="stylesheet" href="../assets/style/achievement.css">
    <style>
        * {
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        body {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            height: 100vh;
            font-family: "微软雅黑", sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #language-switcher {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 100;
            background: rgba(0,0,0,0.5);
            padding: 5px;
            border-radius: 5px;
            display: flex;
        }
        #language-switcher button {
            background: #444;
            color: white;
            border: none;
            padding: 8px 15px;
            margin: 0 3px;
            border-radius: 3px;
            cursor: pointer;
            min-width: 70px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        #skip-btn {
            position: fixed;
            top: 60px;
            right: 18px;
            z-index: 100;
            background: #444;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 3px;
            cursor: pointer;
            min-width: 65px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        #skip-btn:hover {
            background: #555;
        }
        #dialogue-box {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 30px;
            font-size: 20px;
            line-height: 1.5;
            width: 80%;
            max-width: 900px;
            height: 350px;
            border-radius: 10px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        #character-name {
            font-weight: bold;
            font-size: 26px;
            margin-bottom: 80px;
            margin-top: -60px;
            color: #a64032;
            text-align: center;
        }
        #dialogue-text {
            text-align: center;
            margin: 0 auto;
            max-width: 800px;
            margin-top: -15px;

        }
        #press-space-hint {
            font-size: 16px;
            color: #ccc;
            position: absolute;
            bottom: 15px;
            left: 0;
            right: 0;
            text-align: center;
            opacity: 0.7;
            user-select: none;
        }
        #resource-container {
            display: none;
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="loading-overlay">加载中...</div>
    <audio id="bgm" src="../assets/audios/lose.mp3" autoplay loop></audio>

    <div id="language-switcher">
        <button id="btn-zh">中文</button>
        <button id="btn-en">English</button>
    </div>
    <button id="skip-btn">跳过剧情</button>

    <div id="dialogue-box">
        <div id="character-name"></div>
        <div id="dialogue-text"></div>
        <div id="press-space-hint">按空格或回车继续/press space or enter to continue</div>
    </div>
    
    <div id="resource-container"></div>
    <!-- 成就弹窗 -->
    <div class="ach-popup hidden">
      <div class="ach-title">成就标题</div>
      <div class="ach-desc">成就描述</div>
    </div>
<!-- 先加载并实例化 AchievementManager -->
<script src="../../script/managers/AchievementManager.js"></script>
<script>
  window.achievementManager = window.achievementManager || new AchievementManager();

  // 一进入页面就判定成就7
  document.addEventListener('DOMContentLoaded', () => {
    try {
      // 1) 正常打勾（首次完成会自动弹窗）
      window.achievementManager.checkAchievements({ ach7: true });

      // 2) 如果你希望“不管之前是否完成，都弹一次窗”，再手动弹一次：
      const ach = window.achievementManager.achievements.find(a => a.id === 'ach7');
      if (ach) window.achievementManager.showPopup(ach.name, ach.desc);
    } catch (e) { console.warn('激活成就7失败：', e); }
  });
</script>

 
<script>
    window.endingConfig = {
        getEndingConfig: function() {
            return {
                meta: {
                    title: "结局",
                    author: "六个基米哈一天"
                },
                assets: {
                    background: "../backgrounds/ending2.jpg",
                    bgmusic: "../audios/lose.mp3"
                },
                uiText: {
                    zh: { languageBtn: "中文", endText: "【结局结束】" },
                    en: { languageBtn: "English", endText: "[Ending Complete]" }
                },
                dialogues: {
                    zh: [
                        { name: "结局——即使永坠幽冥", text: "真理究竟离我有多远" },
                        { name: "结局——即使永坠幽冥", text: "我不知道" },
                        { name: "结局——即使永坠幽冥", text: "可是我是最精明的人" },
                        { name: "结局——即使永坠幽冥", text: "我有着最精明的头脑和最缜密的思考" },
                        { name: "结局——即使永坠幽冥", text: "只要我控制一切不稳定因素" },
                        { name: "结局——即使永坠幽冥", text: "就可以得到我想要的结果" },
                        { name: "结局——即使永坠幽冥", text: "然而我忘记了 “他”" },
                        { name: "结局——即使永坠幽冥", text: "爱丽丝的回归显然刺激了奥尔菲斯" },
                        { name: "结局——即使永坠幽冥", text: "那个沉沦的小说家逃避的、无辜的、祈求解脱的灵魂" },
                        { name: "结局——即使永坠幽冥", text: "他甚至保持着那可笑的正义感" },
                        { name: "结局——即使永坠幽冥", text: "是的，他搞砸了一切" },
                        { name: "结局——即使永坠幽冥", text: "他去了那场他本不该去的游戏" },
                        { name: "结局——即使永坠幽冥", text: "挽回了不改挽回的人" },
                        { name: "结局——即使永坠幽冥", text: "为了保护她" },
                        { name: "结局——即使永坠幽冥", text: "他解决了诺顿·坎贝尔和梅莉·普林尼" },
                        { name: "结局——即使永坠幽冥", text: "他告诉她" },
                        { name: "结局——即使永坠幽冥", text: "“不要回头……”" },
                        { name: "结局——即使永坠幽冥", text: "我们爆发了前所未有的争执" },
                        { name: "结局——即使永坠幽冥", text: "一旦那个记者离开庄园" },
                        { name: "结局——即使永坠幽冥", text: "这一切的一切被她披露出去" },
                        { name: "结局——即使永坠幽冥", text: "那么我将一无所有" },
                        { name: "结局——即使永坠幽冥", text: "不这是不可以的" },
                        { name: "结局——即使永坠幽冥", text: "我的使命就是保护奥尔菲斯" },
                        { name: "结局——即使永坠幽冥", text: "保护他的一切利益" },
                        { name: "结局——即使永坠幽冥", text: "我必须将她留下" },
                        { name: "结局——即使永坠幽冥", text: "可是我没能想到" },
                        { name: "结局——即使永坠幽冥", text: "我亲手布下的机关最终成为了击败我的武器" },
                        { name: "结局——即使永坠幽冥", text: "他竟然打开了用来释放药剂的管道" },
                        { name: "结局——即使永坠幽冥", text: "大量的七弦琴和摩涅莫绪涅控制住了这个躯体" },
                        { name: "结局——即使永坠幽冥", text: "他控制着我说" },
                        { name: "结局——即使永坠幽冥", text: "“爱丽丝，不要回头……”" },
                        { name: "结局——即使永坠幽冥", text: "管道的高压爆炸让大火更快蔓延" },
                        { name: "结局——即使永坠幽冥", text: "我拼尽全力试图向前追赶" },
                        { name: "结局——即使永坠幽冥", text: "可是我却只能因为我亲手发明的精妙药剂逐渐倒下" },
                        { name: "结局——即使永坠幽冥", text: "意识逐渐模糊" },
                        { name: "结局——即使永坠幽冥", text: "恍惚间我看见她动摇了" },
                        { name: "结局——即使永坠幽冥", text: "她最终还是回头了" },
                        { name: "结局——即使永坠幽冥", text: "在火光之中" },
                        { name: "结局——即使永坠幽冥", text: "她没能走出不归林的大门" },
                        { name: "结局——即使永坠幽冥", text: "故事的最后" },
                        { name: "结局——即使永坠幽冥", text: "乌鸦亲手杀死了夜莺" }
                    ],
                    en: [
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "How far am I from the truth?" },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "I don’t know." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "But I am the most shrewd person—" },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "I have the sharpest mind and the most meticulous thinking." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "As long as I control all unstable factors," },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "I can get the result I want." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "Yet I forgot about “him.”" },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "Alice’s return obviously stimulated Orpheus—" },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "that lost novelist’s soul, which evaded reality, was innocent, and longed for liberation." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "He even retained that ridiculous sense of justice." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "Yes, he messed everything up." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "He went to that game he never should have attended;" },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "he saved someone he never should have saved." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "To protect her," },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "he took care of Norton Campbell and Meri Pliny." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "He told her:" },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "“Don’t look back…”" },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "We had an unprecedented argument." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "If that journalist left the manor," },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "and revealed all of this to the world," },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "then I would lose everything." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "No, that’s impossible." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "My mission is to protect Orpheus," },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "to protect all his interests." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "I must keep her here." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "But I never expected that" },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "the traps I set with my own hands would eventually become the weapons that defeated me." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "He actually opened the pipeline used to release the drugs." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "A large amount of Lyre and Mnemosyne took control of this body." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "He controlled me and said:" },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "“Alice, don’t look back…”" },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "The pipeline’s high-pressure explosion spread the fire faster." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "I tried my best to chase after her," },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "but I could only collapse gradually because of the exquisite drugs I invented with my own hands." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "My consciousness gradually faded." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "In a daze, I saw her hesitate." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "In the end, she still looked back." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "In the midst of the flames," },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "she never made it out of the gate of the Forest of No Return." },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "At the end of the story," },
                        { name: "The ending——Even If I Fall Forever into the Netherworld", text: "the raven killed the nightingale with its own hands." }
                    ]
                }
            };
        }
    };
</script>
    
    <script>
        // 显示成就7
        if (window.achievementManager) {
            window.achievementManager.checkAchievements({ ach7: true });
        }

        class DataManager {
            constructor() {
                this.resourceContainer = document.getElementById('resource-container');
                if (!this.resourceContainer) {
                    this.resourceContainer = document.createElement('div');
                    this.resourceContainer.id = 'resource-container';
                    this.resourceContainer.style.display = 'none';
                    document.body.appendChild(this.resourceContainer);
                }
            }

            async loadImg(src) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = () => reject(new Error(`图片加载失败: ${src}`));
                    img.src = src;
                    this.resourceContainer.appendChild(img);
                });
            }

            async loadAudio(src) {
                return new Promise((resolve, reject) => {
                    const audio = new Audio();
                    audio.oncanplaythrough = () => resolve(audio);
                    audio.onerror = () => reject(new Error(`音频加载失败: ${src}`));
                    audio.src = src;
                    this.resourceContainer.appendChild(audio);
                });
            }

            async loadScript(src) {
                return new Promise((resolve, reject) => {
                    // 直接使用已定义的配置
                    if (window.endingConfig?.getEndingConfig) {
                        resolve(window.endingConfig.getEndingConfig());
                    } else {
                        reject(new Error(`未找到结局配置`));
                    }
                });
            }
        }

        class EndingEngine {
            returnToMain() {
                try {
                    const chId = sessionStorage.getItem('currentChapterId');
                    if (chId) {
                        sessionStorage.setItem('endingComplete', JSON.stringify({
                            chId,
                            unlockNext: true,
                            t: Date.now()
                        }));
                    }
                } catch (e) {
                    console.warn('记录结局完成失败（可忽略）：', e);
                }
                window.location.href = '../game.html?from=ending';
            }

            constructor() {
                this.currentIndex = 0;
                this.isTyping = false;
                this.typeTimeout = null;
                this.typeToken = 0;
                this.currentLang = 'zh';
                this.currentEnding = null;
                this.dataManager = new DataManager();
                this.loadingOverlay = document.getElementById('loading-overlay');

                this.dom = {
                    bg: document.body.style,
                    bgm: document.getElementById("bgm"),
                    name: document.getElementById("character-name"),
                    text: document.getElementById("dialogue-text"),
                    btnZh: document.getElementById("btn-zh"),
                    btnEn: document.getElementById("btn-en"),
                    skipBtn: document.getElementById("skip-btn") 
                };

                // 返回主界面按钮
                this.dom.backBtn = document.createElement('button');
                this.dom.backBtn.textContent = '返回主界面';
                Object.assign(this.dom.backBtn.style, {
                    position: 'fixed',
                    left: '50%',
                    bottom: '32px',
                    transform: 'translateX(-50%)',
                    padding: '10px 18px',
                    border: 'none',
                    borderRadius: '12px',
                    fontSize: '16px',
                    cursor: 'pointer',
                    boxShadow: '0 6px 16px rgba(0,0,0,0.25)',
                    zIndex: '9999',
                    display: 'none',
                    background: 'rgba(255,255,255,0.9)'
                });
                document.body.appendChild(this.dom.backBtn);
                this.dom.backBtn.addEventListener('click', () => this.returnToMain());

                this.initEvents();
                this.loadEnding().catch(err => {
                    console.error('结局引擎初始化失败:', err);
                    this.hideLoading();
                });
            }

            hideLoading() {
                if (this.loadingOverlay) {
                    this.loadingOverlay.style.display = 'none';
                }
            }

            resetTyping(clearText = true) {
                if (this.typeTimeout) {
                    clearTimeout(this.typeTimeout);
                    this.typeTimeout = null;
                }
                this.isTyping = false;
                this.typeToken++;
                if (clearText) this.dom.text.textContent = "";
            }

            getAssetPath(relativePath) {
                // 确保路径正确拼接
                return `assets/${relativePath}`;
            }

            async loadEnding() {
                try {
                    // 直接使用已定义的配置，而不是加载外部脚本
                    this.currentEnding = await this.dataManager.loadScript();
                    await this.initEnding();
                } catch (error) {
                    console.error('加载结局失败:', error);
                    throw error;
                }
            }

            async initEnding() {
                // 触发成就7
                if (window.achievementManager) {
                    window.achievementManager.checkAchievements({ ach7: true });
                }
                if (!this.currentEnding || !this.currentEnding.assets) {
                    throw new Error('结局配置不完整');
                }

                const { assets } = this.currentEnding;
                
                try {
                    // 加载背景图片
                    const bgPath = this.getAssetPath(assets.background);
                    console.log('Loading background image from:', bgPath);
                    
                    const bgImg = await this.dataManager.loadImg(bgPath);
                    // 直接设置背景图片URL
                    document.body.style.backgroundImage = `url('${bgImg.src}')`;
                    
                    try {
                        const bgmPath = this.getAssetPath(assets.bgmusic);
                        const bgmAudio = await this.dataManager.loadAudio(bgmPath);
                        this.dom.bgm.src = bgmAudio.src;
                        this.ensureBGMPlaying();
                    } catch (e) {
                        console.warn('BGM 加载失败，跳过音频但继续剧情：', e);
                    }
                    
                    this.dom.btnZh.textContent = this.currentEnding.uiText.zh.languageBtn;
                    this.dom.btnEn.textContent = this.currentEnding.uiText.en.languageBtn;
                    
                    this.hideLoading();
                    this.startEnding();
                } catch (err) {
                    console.error('结局初始化失败:', err);
                    // 设置一个备用背景
                   // document.body.style.backgroundImage = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
                    this.hideLoading();
                    throw err;
                }
            }

            ensureBGMPlaying() {
                const a = this.dom.bgm;
                if (!a) return;
                a.preload = 'auto';
                a.loop = true;

                const tryPlay = () => a.play().catch(() => {});

                tryPlay();

                if (a.paused) {
                    const onFirstInteract = () => {
                        tryPlay();
                        window.removeEventListener('pointerdown', onFirstInteract);
                        window.removeEventListener('keydown', onFirstInteract);
                    };
                    window.addEventListener('pointerdown', onFirstInteract, { once: true });
                    window.addEventListener('keydown', onFirstInteract, { once: true });
                }
            }

            showCurrentDialogue() {
                this.resetTyping(true);
                if (!this.currentEnding || !this.currentEnding.dialogues) {
                    return;
                }

                const dialogues = this.currentEnding.dialogues[this.currentLang] || [];
                if (this.currentIndex >= dialogues.length) {
                    this.dom.text.textContent = this.currentEnding.uiText[this.currentLang].endText;
                    if (this.dom.backBtn) this.dom.backBtn.style.display = 'block';
                    return;
                }

                const dialogue = dialogues[this.currentIndex];
                this.dom.name.textContent = dialogue.name || "???";
                this.typeText(dialogue.text || "");
            }

            typeText(text) {
                this.resetTyping(true);
                this.isTyping = true;
                const token = this.typeToken;
                let i = 0;
                const typeChar = () => {
                    if (token !== this.typeToken) return;
                    if (i < text.length) {
                        this.dom.text.textContent += text.charAt(i++);
                        this.typeTimeout = setTimeout(typeChar, 40);
                    } else {
                        this.isTyping = false;
                    }
                };
                typeChar();
            }

            next() {
                if (!this.currentEnding || !this.currentEnding.dialogues) return;

                const dialogues = this.currentEnding.dialogues[this.currentLang] || [];
                if (this.currentIndex >= dialogues.length) return;

                if (this.isTyping) {
                    clearTimeout(this.typeTimeout);
                    this.dom.text.textContent = dialogues[this.currentIndex].text || "";
                    this.isTyping = false;
                } else {
                    this.currentIndex++;
                    this.showCurrentDialogue();
                }
            }

            loadLanguage(lang) {
                if (lang === this.currentLang) return;
                this.resetTyping(true);
                this.currentLang = lang;
                this.currentIndex = 0;
                this.showCurrentDialogue();
            }

            initEvents() {
                document.addEventListener("keydown", (e) => {
                    if (["Space", "Enter"].includes(e.code)) {
                        e.preventDefault();
                        this.next();
                    }
                });

                this.dom.btnZh?.addEventListener("click", () => this.loadLanguage('zh'));
                this.dom.btnEn?.addEventListener("click", () => this.loadLanguage('en'));
                this.dom.skipBtn?.addEventListener("click", () => this.skipToEnd());
                document.getElementById("dialogue-box")?.addEventListener("click", () => this.next());
            }

            startEnding() {
                if (this.dom.backBtn) this.dom.backBtn.style.display = 'none';
                this.currentIndex = 0;
                this.showCurrentDialogue();
            }

            skipToEnd() {
                if (!this.currentEnding || !this.currentEnding.dialogues) return;
                
                const dialogues = this.currentEnding.dialogues[this.currentLang] || [];
                this.currentIndex = dialogues.length;
                
                this.resetTyping(true);
                this.dom.name.textContent = "";
                this.dom.text.textContent = this.currentEnding.uiText[this.currentLang].endText;
                
                if (this.dom.backBtn) this.dom.backBtn.style.display = 'block';
            }
        }

        // 初始化引擎
        const engine = new EndingEngine();
    </script>
    <script src="../script/managers/AchievementManager.js"></script>
</body>
</html>