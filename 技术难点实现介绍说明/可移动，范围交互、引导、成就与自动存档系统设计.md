# 可移动，范围交互、引导、成就与自动存档系统设计

## 一、核心功能实现

### （一）人物移动与交互

1. **基础移动控制**

   * 玩家通过 **WASD** 键操控角色，内部维护 `gridX/gridY` 作为逻辑坐标，`renderX/renderY` 作为渲染坐标。
   * 采用基于 **dt（帧间隔）** 的平滑插值移动，确保动画与刷新率解耦。
   * 移动冷却（`STEP_TIME = 0.18s`）避免斜向移动冲突，确保一步一步的格子行走感。

2. **地图建模与碰撞检测**

   * 地图采用二维矩阵表示：`0` 表示可通行，`1` 表示障碍。
   * 移动时先检测目标格子是否为可通行区域，若可行再更新 `gridX/gridY`。

3. **自适应缩放**

   * 通过 `resizeCanvas()` 函数实时调整 Canvas 尺寸，确保不同窗口下画面比例不变，避免变形模糊。

4. **交互点系统**

   * 每张地图在 `MapConfigs` 中定义交互点，包含坐标范围、对话内容、奖励物品或传送信息。
   * 玩家进入交互区域时显示提示（贴图变为感叹号/“按E交互”气泡），按 **E 键**触发对话。
   * 对话框支持逐字机打字效果，**F 键**快速切换下一句或结束，鼠标点击也能关闭。
   * 支持特殊交互：如钢琴对话最后提供“进入演奏/算了”的分支选择。

---

### （二）新手引导系统（GuideManager）

1. **任务清单驱动**

   * 任务以 JSON 数组形式定义，每个任务有 `id/title/desc/autoHide`，确保进度可追踪，且完成后可自动隐藏。

2. **事件绑定与触发**

   * 监听核心事件：
     * 典型例子：
     * `inventory:changed` → 完成拾取任务
     * `piano:enter` → 完成钢琴演奏任务
     * `mapchange` → 完成场景探索任务
     * `fullscreen:enter` → 完成全屏任务
   * 完成任务后自动更新 UI，任务打勾 ✅，引导感更强。

3. **状态存储与导入导出**

   * 任务完成情况存储在 localStorage（`guide_state_v1`），支持 `exportState/importState`，与存档系统兼容。

---

### （三）存档与自动加载系统（SaveManager）

1. **存档结构与持久化**

   * 存档存放在 localStorage（key = `game_saves_v1`），包含：

     * `id`（唯一标识）、`title`（标题）、`data`（运行态数据）、`createdAt/updatedAt`（时间戳）。
   * `data` 内容包括：玩家坐标、当前地图、背包、剧情、世界标记、成就、引导任务进度。

2. **自动存档机制**

   * 在 game.js 中定义全局监听：

     * 点击跳转链接 `<a>`
     * 页面关闭（`beforeunload`）
     * 标签页切后台（`visibilitychange`）
     * `pagehide`（浏览器历史导航）
   * 自动存档槽位唯一（`AUTO_SAVE_ID`），循环覆盖，不会无限膨胀。

3. **自动加载机制**

   * 根据入口来源决定加载策略：

     * **新游戏**（`startNewGame=1`） → 固定 `room1` 出生点。
     * **主页进入**（`from=main`） → 加载手动存档 `lastLoadedSaveId`。
     * **子页面进入**（`from=piano/plot/无参数`） → 优先加载自动存档 `AUTO_SAVE_ID`。
   * `_applyToRuntime()` 会恢复：地图、角色位置、背包、剧情、世界标记与引导进度。

---

## 二、交互与用户体验

1. **移动与交互**

   * 玩家移动自然流畅，进入交互区会出现提示，E 键触发对话，沉浸感强。
   * 逐字打字效果与“呼吸”式提示引导玩家节奏。

2. **引导体验**

   * 初期任务循序渐进，帮助玩家逐步熟悉：全屏 → 打开背包 → 拾取物品 → 弹奏钢琴 → 寻找秘密通道。
   * 完成后清晰反馈，避免遗漏。

3. **存档体验**

   * 玩家可通过菜单手动新建/加载/删除存档。
   * 自动存档保障无感续玩，退出后重新进入游戏也能保持进度。

---

## 三、跨系统对接

1. **GuideManager ↔ SaveManager**

   * 引导任务完成状态纳入存档，读档后恢复一致性。
   * 利用状态变量，完成的任务不再显示

2. **成就系统 && interaction**

   * 特定任务或交互点可触发成就更新，如“完成注册”或“发现暗道”等。
   * 成就系统不随存档而改变，满足成就导向玩家。

3. **剧情系统 && interaction**
   * 只有解锁实验笔记才能解锁剧情系统，保证剧情连贯性
   * 存档时包含 `plot` 和`mapid` 等状态，读档时恢复剧情进度，确保跨页面剧情一致性，
   防止进入第二个页面后刷新又回到第一张地图，影响用户体验。

4. **战斗系统，交互，地图等均有多系统对接....**

---

## 四、模块化设计和目的

* **模块化设计**：

  * Player → 移动渲染和地图
  * Interaction → 场景交互
  * GuideManager → 引导任务
  * SaveManager → 存档与加载
  * PlotManager → 剧情系统
  * AchievementManager → 成就系统
  * InventoryManager → 背包管理系统
    各系统独立解耦，便于维护。

* **玩家体验优化**：

  * 自动存档保证进度无损失
  * 引导系统提升上手体验
  * 交互设计增强沉浸感
  * 同一页面上切换地图减少跳转切换
  * 丰富的交互点和扩大化的坐标范围便于玩家尽情探索

